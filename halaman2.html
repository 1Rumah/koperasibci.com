<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Koperasi BCI â€“ Form, Dasbor Anggota & Admin</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #ffffff; /* FIXED: background putih */
      color: #000000;      /* FIXED: teks hitam */
    }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 18px; }
    .card { background: #fff; border: 1px solid #ddd; border-radius: 14px; padding: 16px; }
    label { display:block; margin:8px 0 6px; color:#000; }
    input, textarea {
      width:100%; padding:10px; border:1px solid #ccc; border-radius:8px;
    }
    .row { display:grid; grid-template-columns:1fr; gap:12px; }
    @media(min-width:720px){.row{grid-template-columns:1fr 1fr}}
    .btn { padding:10px 14px; border-radius:8px; border:1px solid #444; cursor:pointer; }
    .btn.primary { background:#16a34a; color:#fff; border:none; }
    .btn.danger { background:#ef4444; color:#fff; border:none; }
    canvas {
      border:1px dashed #999; border-radius:8px; background:#fff;
      width:100%; max-width:480px; height:170px;
    }
    .hidden { display:none; }
  </style>
</head>
<body>
  <main class="wrap">
    <div class="card">
      <h2>Formulir Pendaftaran Anggota</h2>
      <form id="formPendaftaran">
        <div class="row">
          <div>
            <label>Nama Lengkap</label>
            <input name="nama" required placeholder="Nama sesuai KTP" />
          </div>
          <div>
            <label>NIK</label>
            <!-- FIXED: Validasi harus 16 angka -->
            <input name="nik" required pattern="[0-9]{16}" maxlength="16" placeholder="16 digit angka" />
          </div>
        </div>
        <label>Alamat Lengkap</label>
        <textarea name="alamat" required></textarea>
        <div class="row">
          <div>
            <label>Tempat Lahir</label>
            <input name="tempatLahir" required />
          </div>
          <div>
            <label>Tanggal Lahir</label>
            <input name="tanggalLahir" type="date" required />
          </div>
        </div>
        <div class="row">
          <div>
            <label>No Telepon</label>
            <input name="nohp" required placeholder="08xxxxxxxxxx" />
          </div>
          <div>
            <label>Email</label>
            <input name="email" type="email" required placeholder="email@contoh.com" />
          </div>
        </div>

        <label>Tanda Tangan Digital</label>
        <canvas id="ttdPad"></canvas>
        <div style="margin:8px 0">
          <button type="button" class="btn danger" id="clearTTD">Hapus TTD</button>
        </div>

        <button type="submit" class="btn primary">Kirim & Siapkan Surat</button>
      </form>

      <div id="resultBox" class="hidden" style="margin-top:14px">
        <h3>Download Surat Keanggotaan</h3>
        <div class="tools">
          
          
          <button class="btn" id="btnDownloadPDF">Download PDF</button>
        </div>
        <div style="margin-top:10px" class="hidden" id="previewWrap">
          <canvas id="previewCanvas" style="max-width:100%"></canvas>
        </div>
      </div>
    </div>
  </main>

<script>
const { jsPDF } = window.jspdf;

const form = document.getElementById("formPendaftaran");
const canvasTTD = document.getElementById("ttdPad");
const tctx = canvasTTD.getContext("2d");
let drawing=false;

canvasTTD.addEventListener("mousedown", e => {drawing=true; tctx.beginPath(); tctx.moveTo(e.offsetX,e.offsetY);});
canvasTTD.addEventListener("mousemove", e => {if(drawing){tctx.lineWidth=2;tctx.strokeStyle="#000";tctx.lineTo(e.offsetX,e.offsetY);tctx.stroke();}});
canvasTTD.addEventListener("mouseup", ()=>drawing=false);
document.getElementById("clearTTD").onclick=()=>{tctx.clearRect(0,0,canvasTTD.width,canvasTTD.height);};

let dataGlobal=null;
form.addEventListener("submit", e=>{
  e.preventDefault();
  const fd=new FormData(form);
  dataGlobal={
    nama:fd.get("nama"),
    nik:fd.get("nik"),
    alamat:fd.get("alamat"),
    tempatLahir:fd.get("tempatLahir"),
    tanggalLahir:fd.get("tanggalLahir"),
    nohp:fd.get("nohp"),
    email:fd.get("email"),
    ttd:canvasTTD.toDataURL("image/png")
  };
  document.getElementById("resultBox").classList.remove("hidden");
});

// Buat surat ke canvas
function paintToCanvas(data){
  return new Promise(resolve=>{
    const c=document.createElement("canvas");
    c.width=794; c.height=1123;
    const ctx=c.getContext("2d");
    ctx.fillStyle="#fff"; ctx.fillRect(0,0,c.width,c.height); // FIXED: background putih
    ctx.fillStyle="#000"; ctx.font="14px Arial";
    ctx.fillText("Nama: "+data.nama,100,100);
    ctx.fillText("NIK: "+data.nik,100,120);
    ctx.fillText("Alamat: "+data.alamat,100,140);
    ctx.fillText("TTL: "+data.tempatLahir+", "+data.tanggalLahir,100,160);
    ctx.fillText("No HP: "+data.nohp,100,180);
    ctx.fillText("Email: "+data.email,100,200);
    const s=new Image(); s.src=data.ttd;
    s.onload=()=>{ctx.drawImage(s,500,950,200,80); resolve(c);}
  });
}

document.getElementById("btnPreview").onclick=async()=>{
  if(!dataGlobal) return;
  const c=await paintToCanvas(dataGlobal);
  const prev=document.getElementById("previewCanvas");
  prev.width=c.width; prev.height=c.height;
  prev.getContext("2d").drawImage(c,0,0);
  document.getElementById("previewWrap").classList.remove("hidden");
};
document.getElementById("btnDownloadPNG").onclick=async()=>{
  if(!dataGlobal) return;
  const c=await paintToCanvas(dataGlobal);
  const a=document.createElement("a");
  a.download=`Surat_${dataGlobal.nama}.png`;
  a.href=c.toDataURL("image/png");
  a.click();
};
document.getElementById("btnDownloadPDF").onclick=async()=>{
  if(!dataGlobal) return;
  const c=await paintToCanvas(dataGlobal);
  const pdf=new jsPDF("p","pt","a4");
  pdf.addImage(c.toDataURL("image/png"),"PNG",0,0,595,842);
  pdf.save(`Surat_${dataGlobal.nama}.pdf`);
};
</script>
</body>
</html>
