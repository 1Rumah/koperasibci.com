<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Koperasi Produsen BCI — Pinjaman & Simpanan + Admin</title>

<!-- Signature Pad & jsPDF CDN -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>

<style>
  :root{
    --brand:#2e7d32;        /* hijau utama */
    --brand-2:#7cb342;      /* hijau muda */
    --ink:#1c1c1c;
    --muted:#6b7280;
    --bg:#f6f8fb;
    --card:#ffffff;
    --danger:#dc2626;
    --warn:#d97706;
    --ok:#15803d;
    --radius:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    color:var(--ink); background:var(--bg);
  }
  header{
    position:sticky; top:0; z-index:10;
    background:linear-gradient(180deg,#ffffff 0,#f8fafc 100%);
    border-bottom:1px solid #e5e7eb;
  }
  .topbar{
    max-width:1100px; margin:auto; padding:12px 16px;
    display:flex; align-items:center; gap:12px; justify-content:space-between;
  }
  .brand{display:flex; align-items:center; gap:10px; font-weight:800; color:var(--brand)}
  .brand .logo{width:42px;height:42px;border-radius:12px; background:linear-gradient(135deg,var(--brand),var(--brand-2)); display:grid; place-items:center; color:#fff; font-weight:900}
  nav{display:flex; gap:8px; flex-wrap:wrap}
  nav button{
    border:1px solid #e5e7eb; background:#fff; color:#111827;
    padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:600;
  }
  nav button.active{border-color:var(--brand); color:#fff; background:var(--brand)}
  main{max-width:1100px; margin:18px auto; padding:0 16px 80px}
  .grid{display:grid; grid-template-columns:1fr; gap:16px}
  @media (min-width:980px){ .grid{grid-template-columns:1.1fr .9fr} }

  .card{
    background:var(--card); border:1px solid #e5e7eb; border-radius:var(--radius);
    box-shadow:0 6px 24px rgba(16,24,40,.04); padding:18px;
  }
  h2{margin:0 0 10px 0; font-size:22px}
  h3{margin:18px 0 10px 0; font-size:18px}
  p.hint{color:var(--muted); margin-top:-6px}
  label{font-weight:600; font-size:14px}
  input, select, textarea{
    width:100%; padding:10px 12px; border-radius:12px; border:1px solid #d1d5db; outline:none;
    background:#fff; color:#111827; font-size:14px;
  }
  textarea{min-height:90px; resize:vertical}
  .row{display:grid; grid-template-columns:1fr; gap:12px}
  @media (min-width:680px){ .row.two{grid-template-columns:1fr 1fr} .row.three{grid-template-columns:1fr 1fr 1fr} }
  .actions{display:flex; gap:8px; flex-wrap:wrap}
  .btn{
    appearance:none; border:none; cursor:pointer; border-radius:12px; padding:10px 14px; font-weight:700;
    display:inline-flex; align-items:center; gap:8px;
  }
  .btn.primary{background:var(--brand); color:#fff}
  .btn.secondary{background:#111827; color:#fff}
  .btn.light{background:#fff; color:#111827; border:1px solid #e5e7eb}
  .btn.warn{background:var(--warn); color:#fff}
  .btn.danger{background:var(--danger); color:#fff}
  .badge{display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700}
  .b-new{background:#eef2ff; color:#4338ca}
  .b-pend{background:#fff7ed; color:#9a3412}
  .b-acc{background:#ecfdf5; color:#065f46}
  .b-rej{background:#fef2f2; color:#991b1b}
  table{width:100%; border-collapse:separate; border-spacing:0; font-size:14px}
  th,td{padding:10px 12px; border-bottom:1px solid #e5e7eb; text-align:left; vertical-align:top}
  th{background:#f8fafc; position:sticky; top:0}
  .muted{color:var(--muted)}
  .divider{height:1px; background:#e5e7eb; margin:14px 0}
  .agreement{
    max-height:210px; overflow:auto; border:1px dashed #d1d5db; border-radius:12px; padding:12px; background:#fafafa
  }
  .sig-wrap{border:1px dashed #d1d5db; border-radius:12px; background:#fff}
  canvas#sigpad{width:100%; height:180px; display:block; border-radius:12px}
  .footnote{font-size:12px; color:var(--muted)}
  .hide{display:none}
  .pilltabs{display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap}
  .pilltabs button{padding:10px 14px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; font-weight:700}
  .pilltabs button.active{background:var(--brand); color:#fff; border-color:var(--brand)}
  .kpi{
    display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:12px
  }
  .kpi .box{background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:12px}
  .kpi .n{font-weight:900; font-size:20px}
</style>
<!-- Tambahan CSS untuk preloader -->
<style>
  #preloader {
    position: fixed;
    top:0; left:0; width:100%; height:100%;
    background:#fff;
    display:flex; align-items:center; justify-content:center;
    z-index:99999;
  }
  #preloader img {
    width:500px; height:500px;
  }
  
</style>

</head>
<body>





<header>
  <div class="topbar">
    <div class="brand">
      <!-- Logo lama -->
       <img src="logo.gif" style="height:60px;">

      <div>Koperasi Produsen • Bogor Cassava Industri</div>
    </div>
    <nav>
      <button id="tab-user" class="active">Anggota</button>
      <button id="tab-admin">Admin Pemberkasan</button>
    </nav>
  </div>
</header>

<main>
  <!-- =============== ANGGOTA =============== -->
  <section id="page-user">
    <div class="grid">
      <!-- FORM PINJAMAN -->
      <div class="card">
        <h2>Pengajuan Pinjaman</h2>
        <p class="hint">Isi data berikut dengan benar. Surat Perjanjian wajib dibaca & ditandatangani.</p>

        <form id="loanForm">
          <h3>Data Anggota</h3>
          <div class="row two">
            <div>
              <label>Nomor Anggota</label>
              <input required name="memberId" placeholder="Contoh: BCI-2025-001" />
            </div>
            <div>
              <label>Nama Lengkap</label>
              <input required name="fullName" />
            </div>
          </div>
          <div class="row two">
            <div>
              <label>No. KTP</label>
              <input required name="ktp" maxlength="20" />
            </div>
            <div>
              <label>No. HP / WhatsApp</label>
              <input required name="phone" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Alamat Domisili</label>
              <textarea required name="address" placeholder="Dusun/Desa, Kecamatan, Kabupaten, Provinsi"></textarea>
            </div>
          </div>

          <h3>Detail Pinjaman</h3>
          <div class="row three">
            <div>
              <label>Jumlah Pinjaman (Rp)</label>
              <input required name="amount" type="number" min="0" step="1000" placeholder="5000000" />
            </div>
            <div>
              <label>Tenor</label>
              <select name="tenor" required>
                <option value="6">6 bulan</option>
                <option value="12" selected>12 bulan</option>
                <option value="18">18 bulan</option>
                <option value="24">24 bulan</option>
              </select>
            </div>
            <div>
              <label>Tujuan Pinjaman</label>
              <select name="purpose" required>
                <option value="modal tanam">Modal tanam</option>
                <option value="pupuk & bibit">Pupuk & Bibit</option>
                <option value="alat pertanian">Alat Pertanian</option>
                <option value="lainnya">Lainnya</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Deskripsi Kebutuhan</label>
              <textarea name="desc" placeholder="Rincian penggunaan dana"></textarea>
            </div>
          </div>

          <div class="divider"></div>

          <h3>Surat Perjanjian</h3>
          <div class="agreement" id="agreementBox">
            <h4 style="margin:0 0 6px">SURAT PERJANJIAN PINJAMAN KOPERASI PRODUSEN BCI</h4>
            <p class="footnote">Harap baca hingga akhir. Dengan menandatangani, Anda menyetujui seluruh ketentuan.</p>
            <ol>
              <li>Peminjam merupakan anggota aktif Koperasi Produsen BCI dan bersedia mematuhi AD/ART.</li>
              <li>Dana pinjaman digunakan untuk kebutuhan produktif sektor singkong (budidaya, sarana prasarana, dll).</li>
              <li>Bunga efektif maksimum 2% per bulan dari sisa pokok, biaya admin 1% satu kali di muka.</li>
              <li>Angsuran dibayarkan tiap bulan melalui rekening koperasi atau kas resmi.</li>
              <li>Apabila terjadi keterlambatan > 30 hari, dikenakan denda 1% dari cicilan berjalan.</li>
              <li>Peminjam bersedia dilakukan penilaian usaha & monitoring lahan oleh petugas koperasi.</li>
              <li>Dalam kondisi gagal panen/force majeure, skema restrukturisasi akan dibahas bersama.</li>
              <li>Perselisihan diselesaikan secara musyawarah, dan bila perlu melalui mediasi dinas terkait.</li>
            </ol>
            <p>Dengan ini saya menyatakan telah membaca dan memahami isi perjanjian ini secara penuh.</p>
          </div>

          <div class="row two" style="margin-top:10px">
            <div>
              <label>
                <input type="checkbox" id="agreeChk" /> Saya telah membaca & setuju
              </label>
            </div>
            <div class="footnote" style="display:flex; align-items:center; gap:8px">
              <span class="badge b-new">WAJIB</span> Centang persetujuan untuk mengaktifkan tanda tangan.
            </div>
          </div>

          <div class="row two">
            <div>
              <label>Nama Penandatangan</label>
              <input name="signName" id="signName" placeholder="Sesuai KTP" disabled />
            </div>
            <div>
              <label>Tanggal</label>
              <input name="signDate" id="signDate" type="date" disabled />
            </div>
          </div>

          <div class="sig-wrap">
            <canvas id="sigpad"></canvas>
          </div>
          <div class="actions" style="margin-top:8px">
            <button type="button" class="btn light" id="clearSig" disabled>Hapus Tanda Tangan</button>
            <span class="footnote">Tanda tangan dengan jari & Unduh terlebih dahulu sebelum di kirim.</span>
          </div>

          <div class="divider"></div>

          <div class="actions">
            <button class="btn primary" type="submit">Kirim Pengajuan</button>
            <button class="btn light" type="button" id="previewPDF">Unduh PDF Perjanjian</button>
          </div>
        </form>
      </div>

      <!-- FORM SIMPANAN -->
      <div class="card">
        <h2>Transaksi Simpanan Anggota</h2>
        <div class="pilltabs" id="savTabs">
          <button data-type="pokok" class="active">Simpanan Pokok</button>
          <button data-type="wajib">Simpanan Wajib</button>
          <button data-type="sukarela">Simpanan Sukarela</button>
        </div>
        <form id="saveForm">
          <input type="hidden" name="savType" value="pokok">
          <div class="row two">
            <div>
              <label>Nomor Anggota</label>
              <input required name="memberId" />
            </div>
            <div>
              <label>Nama Lengkap</label>
              <input required name="fullName" />
            </div>
          </div>
          <div class="row two">
            <div>
              <label>Jumlah Setoran (Rp)</label>
              <input required name="amount" type="number" min="0" step="1000" />
            </div>
            <div>
              <label>Metode</label>
              <select name="method">
                <option>Transfer</option>
                <option>Tunai</option>
                <option>VA / Payment Gateway</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Keterangan</label>
              <textarea name="note" placeholder="Opsional"></textarea>
            </div>
          </div>
          <div class="actions">
            <button class="btn secondary" type="submit">Catat Simpanan</button>
          </div>
        </form>

        <div class="divider"></div>
        <h3>Ringkasan (perangkat ini)</h3>
        <div class="kpi">
          <div class="box"><div class="lbl muted">Pengajuan Masuk</div><div class="n" id="kpiLoans">0</div></div>
          <div class="box"><div class="lbl muted">Transaksi Simpanan</div><div class="n" id="kpiSaves">0</div></div>
          <div class="box"><div class="lbl muted">Disetujui</div><div class="n" id="kpiApproved">0</div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- =============== ADMIN =============== -->
  <section id="page-admin" class="hide">
    <div class="card">
      <h2>Admin Pemberkasan</h2>
      <p class="hint">Mode demo. Gunakan sandi <b>admin123</b> untuk membuka tabel. (Ganti dengan autentikasi backend di produksi.)</p>

      <div class="row two">
        <div>
          <label>Kata Sandi Admin</label>
          <input id="adminPass" type="password" placeholder="••••••••" />
        </div>
        <div class="actions" style="align-items:end">
          <button class="btn primary" id="btnOpen">Buka Berkas</button>
          <button class="btn light" id="btnExport">Export CSV</button>
          <button class="btn warn" id="btnSeed">Tambah Data Dummy</button>
          <button class="btn danger" id="btnPurge">Hapus Semua</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div class="card" style="padding:0">
          <div style="padding:12px 12px 0 12px">
            <h3 style="margin:0">Daftar Pengajuan Pinjaman</h3>
            <p class="hint">Klik status untuk mengubah. Tombol “PDF” mengunduh surat perjanjian yang ditandatangani.</p>
          </div>
          <div style="max-height:420px; overflow:auto">
            <table id="loanTable">
              <thead>
                <tr>
                  <th>No</th>
                  <th>Tgl</th>
                  <th>Anggota</th>
                  <th>Jumlah</th>
                  <th>Tenor</th>
                  <th>Tujuan</th>
                  <th>Status</th>
                  <th>PDF</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="card" style="padding:0">
          <div style="padding:12px 12px 0 12px">
            <h3 style="margin:0">Transaksi Simpanan</h3>
          </div>
          <div style="max-height:340px; overflow:auto">
            <table id="savTable">
              <thead>
                <tr>
                  <th>No</th><th>Tgl</th><th>Jenis</th><th>Anggota</th><th>Jumlah</th><th>Metode</th><th>Ket</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </section>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.6/signature_pad.umd.min.js"></script>

<script>
/* ---------- Utilities: storage & helpers ---------- */
const store = {
  read(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback }catch{ return fallback } },
  write(key, val){ localStorage.setItem(key, JSON.stringify(val)) }
};
const money = n => (Number(n)||0).toLocaleString('id-ID');
const todayStr = () => new Date().toISOString().slice(0,10);

/* ---------- Tabs (Anggota / Admin) ---------- */
const pageUser  = document.getElementById('page-user');
const pageAdmin = document.getElementById('page-admin');
document.getElementById('tab-user').onclick = (e)=>{
  e.target.classList.add('active');
  document.getElementById('tab-admin').classList.remove('active');
  pageUser.classList.remove('hide'); pageAdmin.classList.add('hide');
}
document.getElementById('tab-admin').onclick = (e)=>{
  e.target.classList.add('active');
  document.getElementById('tab-user').classList.remove('active');
  pageAdmin.classList.remove('hide'); pageUser.classList.add('hide');
}

/* ---------- KPI Counters ---------- */
function refreshKPIs(){
  const loans = store.read('bci_loans',[]);
  const saves = store.read('bci_savings',[]);
  document.getElementById('kpiLoans').textContent = loans.length;
  document.getElementById('kpiSaves').textContent = saves.length;
  document.getElementById('kpiApproved').textContent = loans.filter(x=>x.status==='Disetujui').length;
}

/* ---------- Agreement + Signature ---------- */
const agreeChk = document.getElementById('agreeChk');
const signName = document.getElementById('signName');
const signDate = document.getElementById('signDate');
const clearSig = document.getElementById('clearSig');
signDate.value = todayStr();

const sigCanvas = document.getElementById('sigpad');
function resizeCanvas(){
  const ratio = Math.max(window.devicePixelRatio || 1, 1);
  const w = sigCanvas.offsetWidth, h = 180;
  sigCanvas.width = w * ratio; sigCanvas.height = h * ratio;
  sigCanvas.style.height = h+'px';
  const ctx = sigCanvas.getContext('2d'); ctx.scale(ratio, ratio);
}
resizeCanvas(); window.addEventListener('resize', resizeCanvas);
const sigPad = new SignaturePad(sigCanvas, { backgroundColor: 'rgba(255,255,255,1)' });

agreeChk.addEventListener('change', ()=>{
  const on = agreeChk.checked;
  signName.disabled = !on; signDate.disabled = !on; clearSig.disabled = !on;
  if(!on){ sigPad.clear(); }
});

/* ---------- Loan Form Submit ---------- */
document.getElementById('loanForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  // basic checks
  if(!agreeChk.checked){ alert('Anda wajib menyetujui Surat Perjanjian.'); return }
  if(sigPad.isEmpty()){ alert('Mohon tanda tangani perjanjian.'); return }
  if(!signName.value || !signDate.value){ alert('Lengkapi nama & tanggal tanda tangan.'); return }

  const fd = new FormData(e.target);
  const data = Object.fromEntries(fd.entries());
  data.createdAt = new Date().toISOString();
  data.status = 'Dalam Pemeriksaan';
  data.signature = sigPad.toDataURL('image/png');

  const loans = store.read('bci_loans',[]);
  loans.push(data); store.write('bci_loans',loans);
  alert('Pengajuan dikirim. Nomor berkas: ' + (loans.length).toString().padStart(4,'0'));
  e.target.reset(); sigPad.clear(); agreeChk.checked=false; signName.disabled=true; signDate.disabled=true; clearSig.disabled=true; signDate.value=todayStr();
  refreshKPIs(); renderLoanTable();
});

/* ---------- Savings Form Submit ---------- */
document.getElementById('saveForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const data = Object.fromEntries(fd.entries());
  data.createdAt = new Date().toISOString();
  const list = store.read('bci_savings',[]);
  list.push(data); store.write('bci_savings',list);
  alert('Transaksi simpanan dicatat.');
  e.target.reset(); document.querySelector('#saveForm [name=savType]').value = document.querySelector('#savTabs button.active').dataset.type;
  refreshKPIs(); renderSavTable();
});

/* ---------- Savings tabs ---------- */
document.getElementById('savTabs').addEventListener('click', (e)=>{
  if(e.target.tagName!=='BUTTON') return;
  [...e.currentTarget.children].forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  document.querySelector('#saveForm [name=savType]').value = e.target.dataset.type;
});

/* ---------- Admin: open, purge, seed, export ---------- */
const adminOk = ()=> document.getElementById('adminPass').value === 'admin123';
document.getElementById('btnOpen').onclick = ()=>{
  if(!adminOk()) return alert('Sandi salah.');
  renderLoanTable(); renderSavTable();
  alert('Berkas ditampilkan.');
};
document.getElementById('btnPurge').onclick = ()=>{
  if(!adminOk()) return alert('Sandi salah.');
  if(confirm('Hapus semua data di perangkat ini?')){ localStorage.removeItem('bci_loans'); localStorage.removeItem('bci_savings'); renderLoanTable(); renderSavTable(); refreshKPIs(); }
};
document.getElementById('btnSeed').onclick = ()=>{
  if(!adminOk()) return alert('Sandi salah.');
  const loans = store.read('bci_loans',[]);
  loans.push({
    memberId:'BCI-2025-001', fullName:'Sukirman', ktp:'3201xxxxxxxx', phone:'0812xxxx', address:'Desa Makmur, Bogor',
    amount:12000000, tenor:'12', purpose:'pupuk & bibit', desc:'Bibit + pupuk NPK', createdAt:new Date().toISOString(), status:'Dalam Pemeriksaan', signature:''
  });
  store.write('bci_loans',loans);
  const saves = store.read('bci_savings',[]);
  saves.push({savType:'wajib', memberId:'BCI-2025-001', fullName:'Sukirman', amount:100000, method:'Transfer', note:'', createdAt:new Date().toISOString()});
  store.write('bci_savings',saves);
  renderLoanTable(); renderSavTable(); refreshKPIs();
};
document.getElementById('btnExport').onclick = ()=>{
  if(!adminOk()) return alert('Sandi salah.');
  const loans = store.read('bci_loans',[]);
  const header = ['tgl','anggota','nama','jumlah','tenor','tujuan','status'];
  const rows = loans.map(x=>[x.createdAt, x.memberId, x.fullName, x.amount, x.tenor, x.purpose, x.status]);
  const csv = [header.join(','), ...rows.map(r=>r.join(','))].join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='pinjaman_bci.csv'; a.click();
};

/* ---------- Admin Tables Render ---------- */
function renderLoanTable(){
  const tb = document.querySelector('#loanTable tbody'); tb.innerHTML='';
  const loans = store.read('bci_loans',[]);
  loans.forEach((x,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${(x.createdAt||'').slice(0,10)}</td>
      <td><b>${x.memberId||''}</b><div class="muted">${x.fullName||''}</div></td>
      <td>Rp ${money(x.amount)}</td>
      <td>${x.tenor} bln</td>
      <td>${x.purpose||''}</td>
      <td>
        <select data-i="${i}" class="statusSel">
          ${['Dalam Pemeriksaan','Disetujui','Ditolak'].map(s=>`<option ${x.status===s?'selected':''}>${s}</option>`).join('')}
        </select>
      </td>
      <td><button class="btn light pdfBtn" data-i="${i}">PDF</button></td>
    `;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('.statusSel').forEach(sel=>{
    sel.onchange = (e)=>{
      const idx = Number(e.target.dataset.i);
      const loans = store.read('bci_loans',[]);
      loans[idx].status = e.target.value;
      store.write('bci_loans',loans);
      refreshKPIs();
    };
  });
  tb.querySelectorAll('.pdfBtn').forEach(btn=>{
    btn.onclick = ()=> downloadPDF(Number(btn.dataset.i));
  });
}

function renderSavTable(){
  const tb = document.querySelector('#savTable tbody'); tb.innerHTML='';
  const list = store.read('bci_savings',[]);
  list.forEach((x,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${(x.createdAt||'').slice(0,10)}</td>
      <td><span class="badge b-new">${(x.savType||'').toUpperCase()}</span></td>
      <td><b>${x.memberId||''}</b><div class="muted">${x.fullName||''}</div></td>
      <td>Rp ${money(x.amount)}</td>
      <td>${x.method||''}</td>
      <td>${x.note||''}</td>
    `;
    tb.appendChild(tr);
  });
}

/* ---------- PDF Generator (Surat Perjanjian) ---------- */
async function makeAgreementDoc(data){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  const M = 56, W = doc.internal.pageSize.getWidth()-M*2;
  const H = doc.internal.pageSize.getHeight();

  // Hitung cicilan per bulan
  const pokok   = Number(data.amount)||0;
  const tenor   = Number(data.tenor)||1;
  const bunga   = 0.02; // 2%
  const angsPokok = pokok/tenor;
  const bungaPerBulan = pokok*bunga;
  const cicilanPerBulan = angsPokok + bungaPerBulan;

  // Judul
  doc.setFont('helvetica','bold'); doc.setFontSize(14);
  doc.text('SURAT PERJANJIAN PINJAMAN', M, 70);
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.text('KOPERASI PRODUSEN BOGOR CASSAVA INDUSTRI', M, 86);
  doc.setDrawColor(30); doc.line(M, 96, M+W, 96);

  // Identitas
  const info = [
    ['Nomor Anggota', data.memberId||'-'],
    ['Nama', data.fullName||'-'],
    ['No. KTP', data.ktp||'-'],
    ['Alamat', data.address||'-'],
    ['No. HP', data.phone||'-']
  ];
  let y = 118;
  info.forEach(row=>{
    doc.setFont('helvetica','bold'); doc.text(row[0]+':', M, y);
    doc.setFont('helvetica','normal'); doc.text(String(row[1]||''), M+140, y); 
    y+=16;
  });

  y+=10;
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  doc.text("Kedua belah pihak sepakat mengikatkan diri dalam Perjanjian Pinjaman dengan ketentuan sebagai berikut:", M, y, {maxWidth:W});
  y+=30;

  // Pasal 1
  doc.setFont('helvetica','bold'); doc.text("Pasal 1 – Objek Pinjaman", M, y); y+=16;
  doc.setFont('helvetica','normal');
  doc.text(`1. Peminjam memperoleh pinjaman uang sebesar Rp ${money(pokok)}.`, M, y, {maxWidth:W}); y+=14;
  doc.text(`2. Pinjaman diberikan untuk keperluan ${data.purpose||'-'}.`, M, y, {maxWidth:W}); y+=22;

  // Pasal 2
  doc.setFont('helvetica','bold'); doc.text("Pasal 2 – Jangka Waktu", M, y); y+=16;
  doc.setFont('helvetica','normal');
  doc.text(`1. Jangka waktu pinjaman adalah ${tenor} bulan.`, M, y, {maxWidth:W}); y+=14;
  doc.text(`2. Pinjaman wajib dilunasi paling lambat tanggal ${data.dueDate||'-'}.`, M, y, {maxWidth:W}); y+=22;

  // Pasal 3
  doc.setFont('helvetica','bold'); doc.text("Pasal 3 – Jasa/Bunga Pinjaman", M, y); y+=16;
  doc.setFont('helvetica','normal');
  doc.text("1. Peminjam dikenakan jasa pinjaman sebesar 2% per bulan.", M, y, {maxWidth:W}); y+=14;
  doc.text("2. Pembayaran jasa dilakukan bersamaan dengan cicilan pokok atau pelunasan.", M, y, {maxWidth:W}); y+=14;
  doc.text(`3. Jumlah cicilan per bulan: Rp ${money(cicilanPerBulan)} (Pokok Rp ${money(angsPokok)} + Bunga Rp ${money(bungaPerBulan)}).`, M, y, {maxWidth:W}); 
  y+=22;

  // Pasal 4
  doc.setFont('helvetica','bold'); doc.text("Pasal 4 – Agunan", M, y); y+=16;
  doc.setFont('helvetica','normal');
  doc.text("1. Sebagai jaminan, Peminjam menyerahkan Sertifikat Rumah/Kebun dengan rincian:", M, y, {maxWidth:W}); y+=14;
  doc.text(`   - Jenis Sertifikat : ${data.certType||'-'}`, M, y, {maxWidth:W}); y+=14;
  doc.text(`   - Nomor Sertifikat: ${data.certNo||'-'}`, M, y, {maxWidth:W}); y+=14;
  doc.text(`   - Luas Tanah/Bangunan: ${data.certArea||'-'}`, M, y, {maxWidth:W}); y+=14;
  doc.text(`   - Atas Nama: ${data.certOwner||'-'}`, M, y, {maxWidth:W}); y+=16;
  doc.text("2. Sertifikat disimpan oleh koperasi sampai pinjaman lunas.", M, y, {maxWidth:W}); y+=22;

  // Pasal 5
  doc.setFont('helvetica','bold'); doc.text("Pasal 5 – Hak & Kewajiban", M, y); y+=16;
  doc.setFont('helvetica','normal');
  const hak = [
    "Koperasi berhak menahan agunan sampai seluruh kewajiban dilunasi.",
    "Peminjam berkewajiban membayar angsuran sesuai jadwal.",
    "Apabila terjadi wanprestasi, koperasi berhak mengeksekusi agunan sesuai hukum yang berlaku."
  ];
  hak.forEach(h=>{
    const lines = doc.splitTextToSize('- '+h, W);
    doc.text(lines, M, y); y+=14*lines.length;
  });
  y+=10;

  // Pasal 6
  doc.setFont('helvetica','bold'); doc.text("Pasal 6 – Lain-lain", M, y); y+=16;
  doc.setFont('helvetica','normal');
  doc.text("Hal-hal yang belum diatur akan disepakati kemudian secara musyawarah.", M, y, {maxWidth:W}); y+=14;
  doc.text("Perjanjian ini dibuat rangkap dua bermaterai cukup, masing-masing memiliki kekuatan hukum yang sama.", M, y+14, {maxWidth:W});
  y+=40;

  // Tanda tangan
  const sigW = 220, sigH = 80;
  doc.rect(M, y-14, sigW, sigH+34);
  doc.text('Tanda Tangan Peminjam', M+10, y);
  if(data.signature){
    const imgY = y+6;
    doc.addImage(data.signature, 'PNG', M+10, imgY, sigW-20, sigH);
  }
  doc.text('Nama: ' + (data.signName||''), M, y+sigH+24);
  doc.text('Tanggal: ' + (data.signDate||''), M+140, y+sigH+24);

  // Footer
  doc.setFontSize(9); doc.setTextColor(120);
  doc.text('Dokumen ini dibuat otomatis oleh Sistem Koperasi Produsen BCI', M, H-40);

  return doc;
}

function downloadPDF(idx){
  const loans = store.read('bci_loans',[]);
  const data = loans[idx]; if(!data){ return }
  makeAgreementDoc(data).then(doc=>doc.save(`Perjanjian_${data.memberId||'BCI'}.pdf`));
}

// “Unduh PDF” dari halaman anggota (pakai data sementara form)
document.getElementById('previewPDF').onclick = ()=>{
  const f = document.getElementById('loanForm');
  const fd = new FormData(f);
  const data = Object.fromEntries(fd.entries());
  data.signName = document.getElementById('signName').value;
  data.signDate = document.getElementById('signDate').value;
  data.signature = sigPad.isEmpty()? null : sigPad.toDataURL('image/png');
  makeAgreementDoc(data).then(doc=>doc.save('Perjanjian_preview.pdf'));
}

/* ---------- Init ---------- */
refreshKPIs(); renderLoanTable(); renderSavTable();
</script>

<div id="preloader">
  <img src="preloader.gif" alt="Loading...">
</div>

<script>
  window.addEventListener("load", function(){
    setTimeout(function(){
      // fade out preloader
      document.getElementById("preloader").style.opacity = "0";
      setTimeout(function(){
        document.getElementById("preloader").style.display = "none";
        document.body.classList.add("loaded"); // munculkan body
      }, 600); // waktu tunggu sama dengan transition preloader
    }, 2000); // delay 2 detik
  });
</script>


</body>
</html>

